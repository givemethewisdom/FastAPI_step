name: CI Pipeline

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    # Добавляем сервисы PostgreSQL и Redis
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mydatabase
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio flake8 pre-commit
          pip install black==25.9.0
          pip install python-dotenv psycopg2-binary  # Добавляем для БД

      - name: Create .env file for tests
        run: |
          cat > .env << EOF
          # Для CI используем localhost
          POSTGRES_URL_SYNC=postgresql+psycopg2://postgres:postgres@localhost:5432/mydatabase
          POSTGRES_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/mydatabase
          DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/mydatabase
          SECRET_KEY=test_secret_key_for_ci_123456
          DEBUG=True
          REDIS_URL=redis://localhost:6379/0
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          POSTGRES_DB=mydatabase
          EOF
          
          # Показываем что создали (без паролей)
          cat .env | grep -v PASSWORD | grep -v SECRET

      - name: Wait for PostgreSQL
        run: |
          timeout 60 bash -c 'until pg_isready -h localhost -p 5432 -U postgres; do sleep 2; done'

      - name: Wait for Redis
        run: |
          timeout 30 bash -c 'until redis-cli -h localhost -p 6379 ping; do sleep 2; done'

      - name: Run pre-commit hooks
        run: |
          pre-commit install
          pre-commit run --all-files || true

      - name: Run tests
        run: pytest tests/ -v
        env:
          # Явно передаем переменные на всякий случай
          POSTGRES_URL_SYNC: postgresql+psycopg2://postgres:postgres@localhost:5432/mydatabase
          SECRET_KEY: test_secret_key_for_ci_123456

      - name: Show black version
        run: black --version